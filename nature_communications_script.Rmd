---
title: "Anterior, not posterior hippocampus mediates income effects on children's cognition"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Load relevant packages and data
```{r}
library(lme4); library(lmerTest); library(mediation); library(tidyverse); library(data.table); library(hausekeep)
#package versions
#lme4_1.1-18-1; lmerTest_3.1-0; mediation_4.4.7; dtplyr_0.0.3; tidyverse_1.2.1; data.table_1.12.6; tidyr_1.0.0;  ggplot2_3.2.0;    
#read csv
pingSubset <- fread("nc_data.csv")
```

#### Analyses to assess whether income is related to episodic memory and language scores ####
```{r memory ~ income models}
Income_memory.m <- lm(TBX_ibam_scr ~ logIncome3 +AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summary(Income_memory.m)

Income_memory_nonlinear.m <- lm(TBX_ibam_scr ~ logIncome3 +AgeC + Age2 + Age3 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_memory_nonlinear.m)
#income significantly correlates with memory in both models
```

```{r vocabulary ~ income models}
Income_language.m <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summary(Income_language.m)

Income_language.m_nonlinear <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC + Age2, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_language.m_nonlinear)
#vocab significantly correlates with memory in both models
```

```{r processing speed ~ income models (control analysis)}
processingspeed_income.m <- lm(TBX_pspac_scr~ logIncome3 + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr)]); summary(processingspeed_income.m) 
#control analysis - income significantly correlates with processing speed
```

```{r FDR correction (scores ~ income)}
corrected_ps <- data.table(test = c("memory_income", "vocab_income", "ps_income"), ps = c(7.62e-08, 2e-16, .00757))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]
```

Test how far apart in years lowest and highest income bracket are in cognitive scores
```{r Memory in lowest vs. higher income bracket}
#Compute model, in which the dependent variable, memory scores, are z scores
memory_income_gap.m <- lm(TBX_ibam_scrZ ~ logIncome3 + GenderEC + AgeC, data = pingSubset);summary(memory_income_gap.m) 

#save objects: intercept for memory scores, income, age, and the minimum and maximum values for income
memoryScore_intercept = as.numeric(memory_income_gap.m$coefficients[1]) #intercept for memory
income_intercept.m = as.numeric(memory_income_gap.m$coefficients[2]) #intercept for income
age_intercept.m = as.numeric(memory_income_gap.m$coefficients[4]) #intercept for age
income_min = pingSubset[, min(logIncome3, na.rm=T)]#minimum income 
income_max = pingSubset[, max(logIncome3, na.rm=T)]#max income 

#Test how many years memory ability in the poorest children lags behind memory ability in the wealthiest children
memoryZ_lowestIncome = memoryScore_intercept + (income_intercept.m * income_min) #z scores of memory for lowest income bracket 
memoryZ_highestIncome = memoryScore_intercept + (income_intercept.m * income_max)#z scores of memory for highest income bracket 
Memory_lag_years = (memoryZ_highestIncome -  memoryZ_lowestIncome)/age_intercept.m
```

```{r Language in lowest vs. higher income bracket}
#Compute model, in which the dependent variable, language scores, are z scores
language_income_gap.m <- lm(TBX_VOCAB_THETAZ ~ logIncome3 + GenderEC + AgeC, data = pingSubset); summary(language_income_gap.m)

#save objects: intercept for language scores, income, age, and the minimum and maximum values for income
languageScore_intercept = as.numeric(language_income_gap.m$coefficients[1]) #intercept for language
income_intercept.l = as.numeric(language_income_gap.m$coefficients[2]) #intercept for income
age_intercept.l = as.numeric(language_income_gap.m$coefficients[4]) #intercept for age
income_min = pingSubset[, min(logIncome3, na.rm=T)]#minimum income 
income_max = pingSubset[, max(logIncome3, na.rm=T)]#max income 

#Test how many years language ability in the poorest children lags behind language ability in the wealthiest children
languageZ_lowestIncome = languageScore_intercept + (income_intercept.l * income_min) #z scores of language for lowest income bracket 
languageZ_highestIncome = languageScore_intercept + (income_intercept.l * income_max)#z scores of language for highest income bracket 
language_lag_years = (languageZ_highestIncome -  languageZ_lowestIncome)/age_intercept.l
```

Models testing whether age moderates income-cognition relationships  
```{r memory ~ income * age}
Income_memory_age.m <- lm(TBX_ibam_scr ~ AgeC * logIncome3 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_memory_age.m)
```

```{r vocab ~ income * age}
Income_language_age.m <- lm(TBX_VOCAB_THETA ~  AgeC * logIncome3 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_language_age.m)
```

```{r FDR correction (scores ~ income * age)}
age_inter_income_scores <- data.table(test = c("age_inter_income_memory", "age_inter_income_vocab"), ps = c(.420, .354))
```

Does income correlate with  memory and vocab more than processing speed control?
```{r put all variables on the same scale}
#z score all cognitive scores
pingSubset[!is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr) & !is.na(tail_adjustRO_new), TBX_ibam_scr_C := scale(TBX_ibam_scr)]
pingSubset[!is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr) & !is.na(tail_adjustRO_new), TBX_VOCAB_THETA_C := scale(TBX_VOCAB_THETA)]
pingSubset[!is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr) & !is.na(tail_adjustRO_new) & !is.na(TBX_pspac_scr), TBX_pspac_scr_C := scale(TBX_pspac_scr)]
```

```{r create long form data}
subset_long = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr_C) & !is.na(TBX_pspac_scr_C), .(ID, logIncome3, TBX_ibam_scr_C, TBX_VOCAB_THETA_C, TBX_pspac_scr_C, head_adjustRO_new, DeviceSerialNumber, AgeC, GenderEC)] #subset variables of interest and convert to long form
subset_long = setDT(subset_long)
subset_long[, n_distinct(ID)]
subset_long = gather(subset_long, task, score, -c(ID, logIncome3, head_adjustRO_new, DeviceSerialNumber, AgeC, GenderEC))
subset_long = subset_long%>%arrange(ID) 
subset_long = tbl_dt(subset_long)
subset_long[, n_distinct(ID)]
subset_long[is.na(score)]
subset_long[, n_distinct(task), by = ID][V1 !=3]
```

```{r scores ~ task * income}
interaction_task_scores_income <- lmer(score ~ logIncome3 * task + AgeC + GenderEC + (1|ID), data  = subset_long);summary(interaction_task_scores_income)

#check whether residuals of model are normally distributed
values <- resid(interaction_task_scores_income)
normally_dist_values <- rnorm(n = 2070, mean = mean, sd = sd)
hist(normally_dist_values)
hist(values)
ks.test(x = values, y = normally_dist_values)
```

Cognitive scores ~ income * income subsample
```{r memory ~ income * income subsample}
Income_memory_income_subsample.m <- lm(TBX_ibam_scr ~ income3 * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summary(Income_memory_income_subsample.m)
##income (in raw dollars) has a larger effect on memory in lower income subsample
```

```{r vocab ~ income * incomesubsample}
Income_language_income_subsample.m <- lm(TBX_VOCAB_THETA ~ income3 * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summary(Income_language_income_subsample.m)
#income (in raw dollars) has a larger effect on vocab in lower income subsample
```

```{r processing speed ~ income * income subsample }
Income_processing_speed_income_subsample.m <- lm(TBX_pspac_scr ~ income3 * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summary(Income_processing_speed_income_subsample.m)
#income (in raw dollars) does not affect processing speed differently in higher and lower income subsample
```

```{r FDR correction (scores ~ income * income subsample)}
group_inter_income_scores <- data.table(test = c("group__inter_income_memory", "group_inter_income_vocab", "group_inter_income_ps"), ps = c(0.00257, 0.000297, 0.667))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

# join
corrected_ps <- rbind(age_inter_income_scores, group_inter_income_scores)
```

Cognitive scores ~ income + age + sex + income separately for low and high income subsample
```{r memory ~ income separately for low and high income subsamples}
#low income (linear effect of age only)
Income_memory_income_subsample_low.m <- lm(TBX_ibam_scr ~ logIncome3 + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summary(Income_memory_income_subsample_low.m)

#low income (added nonlinear effect of age)
Income_memory_income_subsample_low.m_nonlinear <- lm(TBX_ibam_scr ~ logIncome3 + AgeC + Age2 +GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_memory_income_subsample_low.m_nonlinear)

#high income
Income_memory_income_subsample_high.m <- lm(TBX_ibam_scr ~ logIncome3 + AgeC  + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == 1]); summary(Income_memory_income_subsample_high.m)
```

```{r vocabulary ~ income separately for low and high income subsamples}
#lower income group (linear effect of age only)_
Income_language_low_income.m <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summary(Income_language_low_income.m)

#lower income gorup (added nonlinear effect of age)
Income_language_low_income.m_nonlinear <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC + Age2, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_language_low_income.m_nonlinear)

#higher income group
Income_language_high_income.m <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == 1]); summaryh(Income_language_high_income.m)
```

```{r FDR correction (scores ~ income) in separate subsamples}
scores_income_separate_group <- data.table(test = c("memory_income_low", "memory_income_high", "vocab_income_low", "vocab_income_high"), ps = c(4.38e-06,  0.0428, 1.77e-06, 0.00162))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

# join
corrected_ps <- rbind(corrected_ps, scores_income_separate_group)
```

Control analysis: Adding minority status as covariate and interaction term
```{r memory scores ~ income + minority status; and * minority status}
#interaction with minority status
#full
Income_memory_minority_moderation.m <- lm(TBX_ibam_scr ~ logIncome3 * minority_status +AgeC+ GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_memory_minority_moderation.m)

#low income
Income_memory_minority_moderation.m_low_income <- lm(TBX_ibam_scr ~ logIncome3 * minority_status +AgeC+ GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_memory_minority_moderation.m_low_income)

#control for minority status
#full sample
Income_memory_minority.m_full <- lm(TBX_ibam_scr ~ logIncome3 +AgeC + GenderEC + minority_status, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_memory_minority.m_full)

#lower income subsample
Income_memory_minority.m_lower_subsample <- lm(TBX_ibam_scr ~ logIncome3 +AgeC + GenderEC + minority_status, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_memory_minority.m_lower_subsample)
```

```{r vocabulary scores ~ income + minority status; and * minority status}
#moderation with minority status
#full
Income_language_minority_moderation.m <- lm(TBX_VOCAB_THETA ~ logIncome3 * minority_status+ GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_language_minority_moderation.m)

#low income
Income_language_minority_moderation.m_low_income_subsample <- lm(TBX_VOCAB_THETA ~ logIncome3 * minority_status+ GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_language_minority_moderation.m_low_income_subsample)


#control for minority status
#full
Income_language_minority.m_full <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC +minority_status, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Income_language_minority.m_full)

#low income
Income_language_minority.m_low_subsample <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_language_minority.m_low_subsample)
```

```{r FDR correction (scores ~ income * minority status)}
minority_inter_income_scores <- data.table(test = c("minority_inter_income_memory_full", "minority_inter_income_vocab_full", "minority_inter_income_memory_low", "minority_inter_income_vocab_low"), ps = c(.301, .497, .257, .849))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

# join
corrected_ps <- rbind(corrected_ps, minority_inter_income_scores)
```

Cognitive scores ~ income separately for minority status and non minority status individuals in low income subgroup
```{r memory scores ~ income by minority status in lower income}
#non minority status
Income_memory_nonminority.m <- lm(TBX_ibam_scr ~ logIncome3 +AgeC+ GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1 & minority_status == -1]); summaryh(Income_memory_nonminority.m)

#minority status
Income_memory_minority_status.m <- lm(TBX_ibam_scr ~ logIncome3 +AgeC+ GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1 & minority_status == 1]); summary(Income_memory_minority_status.m)
```

```{r vocabulary scores ~ income by minority status in lower income}
#non minority status
Income_language_nonminority_low.m <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC , data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1 & minority_status == -1]); summaryh(Income_language_nonminority_low.m)

#minority status
Income_language_minority_low.m <- lm(TBX_VOCAB_THETA ~ logIncome3 + GenderEC + AgeC , data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & incomeSplit == -1 & minority_status == 1]); summaryh(Income_language_minority_low.m)
```

```{r FDR correction (scores ~ income + minority status) in lower}
income_scores_minority_low <- data.table(test = c("income_memory_minority_low", "income_memory_non_minority_low", "income_vocacb_minority_low", "income_vocab_non_minority_low"), ps = c(0.000474, .014, .038, .003))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

corrected_ps <- rbind(corrected_ps, income_scores_minority_low)
corrected_ps[, ps_adjusted := p.adjust(ps, method  = 'fdr')]
```
 
#### Analyses to assess whether income correlates with anterior or posterior hippocampal volumes ####
Subregion volumes ~ income models
```{r anterior vols ~ income}
Income_anterior.m <- lm(head_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(Income_anterior.m)

pingSubset[, .(GenderEC, Gender)]
```

```{r posterior vols ~ income}
Income_posterior.m <- lm(tail_adjustRO_new ~ logIncome3 + AgeC  + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new)]); summary(Income_posterior.m)
```

```{r FDR correction (vols ~ income )}
corrected_ps <- data.table(test = c("income_anterior", "income_posterior", "income_inter_subregion"), ps = c(0.000413, 0.156,  0.000298))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]
```
 
Age moderations of subregion vols ~ income models
```{r anterior vols ~ income * age}
Income_anterior_age.m <- lm(head_adjustRO_new ~ logIncome3 * AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(Income_anterior_age.m)
```

```{r posterior vols ~ income * age}
Income_posterior_age.m <- lm(tail_adjustRO_new ~ AgeC * logIncome3 + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new)]); summary(Income_posterior_age.m)
```

```{r FDR correction (vol ~ income * age) }
age_inter_income_vols <- data.table(test = c("ager_inter_income_anterior", "age_inter_income_posterior"), ps = c(0.51926, 0.501))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]
```
 
Income subsample moderations of subregion vols ~ income models
```{r anterior vols ~ income * income subsample}
Income_anterior_interaction_income.m <- lm(head_adjustRO_new ~ income3 * incomeSplit + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(Income_anterior_interaction_income.m) #results show that gains in income (in raw dollars) matter more for low than high subsample
```

```{r posterior vols ~ income * income subsample}
Income_posterior_interaction_income.m <- lm(tail_adjustRO_new ~ income3 * incomeSplit+ AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new)]); summary(Income_posterior_interaction_income.m)
```

```{r FDR correction (vol ~ income * subsample) }
group_inter_income_vols <- data.table(test = c("group_inter_income_anterior", "group_inter_income_posterior"), ps = c(0.01042, 0.040))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

# join
corrected_ps <- rbind(age_inter_income_vols, group_inter_income_vols)
```
 
HPC subregion ~ income separately for higher and lower income subsample
```{r anterior ~ income separately for high and low income subsample}
#low income
Income_anterior_low_income.m <- lm(head_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(Income_anterior_low_income.m)

#high income
Income_anterior_high_income.m <- lm(head_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summaryh(Income_anterior_high_income.m)
```

```{r posterior ~ income separately for high and low income subsample}
# low income
Income_posterior_low_income.m <- lm(tail_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == -1]); summary(Income_posterior_low_income.m)

#high income
Income_posterior_high_income.m <- lm(tail_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == 1]); summary(Income_posterior_high_income.m)

```

```{r FDR correction (vol ~ income) in separate subsamples }
income_vols_group <- data.table(test = c("income_anterior_low", "income_anterior_high", "income_posterior_low", "income_poserior_high"), ps = c(.0010, .944, 0.0282,0.9311))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

#join
corrected_ps <- rbind(corrected_ps, income_vols_group)
```

HPC subregion ~ income * minority status for full sample and lower income subsample
```{r anterior hpc ~ income * minority status}
#full sample 
Income_anterior_minority_status_interaction.m <- lm(head_adjustRO_new ~ logIncome3 * minority_status + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(Income_anterior_minority_status_interaction.m)

#lower income
Income_anterior_minority_status_interaction_low_income.m <- lm(head_adjustRO_new ~ logIncome3 * minority_status + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(Income_anterior_minority_status_interaction_low_income.m)

#lower income nminority status
Income_anterior_minority_status_low_income.m <- lm(head_adjustRO_new ~ logIncome3+ AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1 & minority_status == 1]); summary(Income_anterior_minority_status_low_income.m)

#lower income nonminority status
Income_anterior_nonminority_status_low_income.m <- lm(head_adjustRO_new ~ logIncome3+ AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1 & minority_status == -1]); summary(Income_anterior_nonminority_status_low_income.m)

#higher income
Income_anterior_minority_status_interaction_high_income.m <- lm(head_adjustRO_new ~ logIncome3 * minority_status + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summary(Income_anterior_minority_status_interaction_high_income.m)
```

```{r posterior hpc vols ~ income * minority status}
#full sample
Income_posterior_minority_status_interaction.m <- lm(tail_adjustRO_new ~ logIncome3 * minority_status+ AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new)]); summary(Income_posterior_minority_status_interaction.m)

#lower income only - posterior
Income_posterior_minority_status_interaction_low_income.m <- lm(tail_adjustRO_new ~ logIncome3 * minority_status+ AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(Income_posterior_minority_status_interaction_low_income.m)
```

```{r FDR correction (vol ~ income) in separate subsamples }
minority_inter_vols_income <- data.table(test = c("minority_inter_anterior_income", "minority_inter_anterior_income_low", "minority_inter_posterior_income", "minority_inter_posterior_income_low"), ps = c(0.07155, 0.201318 , 0.245, .408))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

# join
corrected_ps <- rbind(corrected_ps, minority_inter_vols_income)
```
 
HPC vols ~ income + minority status
```{r anterior hpc ~ income + minority status}
#full sample
Income_anterior_minority_status.m <- lm(head_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber + minority_status, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(Income_anterior_minority_status.m)

#lower income only
Income_anterior_minority_status_low_income.m <- lm(head_adjustRO_new ~ logIncome3 + AgeC + GenderEC +  DeviceSerialNumber + minority_status, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(Income_anterior_minority_status_low_income.m)
```

```{r FDR correction (vol ~ income) by minority status }
income_anterior_minority <- data.table(test = c("income_anterior_minority", "income_anterior_minority_low"), ps = c(0.37, 0.018))

#join
corrected_ps <- rbind(corrected_ps, income_anterior_minority) #left off here
corrected_ps[, ps_adjusted := p.adjust(ps, method = 'fdr')]
```
 
Test whether income has a larger influence on the volume of the anterior than posterior hippocampus
```{r interaction between region and income to predict subregion volumes}
longpingSubset_analysis <- setDT(gather(pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), 
                                             .(ID, head_adjustRO_new, tail_adjustRO_new, logIncome3, AgeC, GenderEC, 
                                               DeviceSerialNumber2)], region, volume, -c(ID, AgeC, logIncome3, GenderEC, 
                                              DeviceSerialNumber2)))

longpingSubset_analysis[region == "tail_adjustRO_new", region2 := 1]
longpingSubset_analysis[region == "head_adjustRO_new", region2 := 0]

interaction.model = lmer(volume ~  region2  +(1|ID), data = longpingSubset_analysis); summaryh(interaction.model)
interaction.model = lmer(volume ~  region2 + logIncome3 + AgeC + (1|ID), data = longpingSubset_analysis); summaryh(interaction.model)

pingSubset[, mean(head_adjustRO_new, na.rm=T)]
pingSubset[, mean(tail_adjustRO_new, na.rm=T)]

#age interaction
interaction.model = lmer(volume ~  logIncome3 * region  + AgeC + GenderEC +  DeviceSerialNumber2  +(1|ID), data = longpingSubset_analysis); summary(interaction.model)
```

```{r make new long dataframe for creating figure of interaction between income and subregion volumes}
#for visualizing the interaction, residualized out the effects of age, gender and device serial number 
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), head_adjustRO_new_plotting := residuals(lm(head_adjustRO_new ~ GenderEC  + AgeC + DeviceSerialNumber))]
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), tail_adjustRO_new_plotting := residuals(lm(tail_adjustRO_new ~ GenderEC  + AgeC + DeviceSerialNumber))]

#z score values for anterior and posterior hippocampus so we can visualize how different these values are by income
pingSubset[!is.na(tail_adjustRO_new_plotting), posteriorZ_plot := scale(tail_adjustRO_new_plotting)]
pingSubset[!is.na(head_adjustRO_new_plotting), headZ_plot := scale(head_adjustRO_new_plotting)]

#convert to long form
toGather <- pingSubset[!is.na(posteriorZ_plot) & !is.na(headZ_plot), .(ID, posteriorZ_plot, headZ_plot, logIncome3, AgeC, GenderEC, DeviceSerialNumber2)]
longpingSubset <- gather(toGather, region, volume, -c(ID, AgeC, logIncome3, GenderEC, DeviceSerialNumber2))
setDT(longpingSubset)
longpingSubset[region == "tail_adjustRO_new", region2 := 1]
longpingSubset[region == "head_adjustRO_new", region2 := -1]

longpingSubset$region <- relevel(x = as.factor(longpingSubset$region), ref = "posteriorZ_plot")
longpingSubset[region  == "posteriorZ_plot", region := "Posterior"]
longpingSubset[region  == "headZ_plot", region := "Anterior"]
incomeList = c(5, 10, 20, 40, 80, 160, 300)
incomeList = as.character(incomeList)
incomeLog = log(incomeList)
```

```{r plotting the interaction between region and income to predict subregion volumes}
#plot figure
ggplot(longpingSubset, aes(logIncome3, volume, col = region)) +
    geom_smooth(formula = y ~ x, method = 'lm')+
  #geom_jitter(alpha = 0.2) +
   labs(y = "Volumes (z scores)", x = "Income (thousands)") +
ggtheme2 +
    scale_x_continuous(breaks = c(incomeLog), labels = c(incomeList)) +
  scale_color_manual(values  = c(posteriorCol, anteriorvolscolor)) +
  scale_y_continuous(breaks = c(-0.5, -0.25, 0, 0.25))
ggsave(filename = "income_subregion_lines.png",width = 5, height = 3)


longpingSubset = left_join(longpingSubset, pingSubset[, .(ID, income3)])
longpingSubset
ggplot(longpingSubset, aes(income3/1000, volume, col = region)) +
  ggtheme2 +
    geom_smooth(formula = y ~ x, method = 'lm', data = longpingSubset[income3 < 76000])+
      geom_smooth(formula = y ~ x, method = 'lm', data = longpingSubset[income3 > 76000])+
scale_color_manual(values  = c(posteriorCol, anteriorvolscolor))+
   labs(y = "Volumes (z scores)", x = "Income (thousands; linear scale)") 

ggsave(filename = "income_linear_antPost.png",width = 5, height = 3)
```


#### Analyses to assess whether volumes predict episodic memory and language abilities ####
```{r memory ~ anterior HPC}
#full sample
memory_anterior.m = lm(TBX_ibam_scr ~ head_adjustRO_new + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(memory_anterior.m)

memory_anterior.m = lm(TBX_ibam_scr ~ head_adjustRO_new + AgeC + Age2 + Age3 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(memory_anterior.m)

#low income subsample
memory_anterior_low_income.m = lm(TBX_ibam_scr ~ head_adjustRO_new + AgeC + GenderEC +logIncome3, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summaryh(memory_anterior_low_income.m)

#low income
memory_anterior_low_income.m = lm(TBX_ibam_scr ~ head_adjustRO_new + AgeC + Age2 +GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summaryh(memory_anterior_low_income.m)
```

```{r memory ~ posterior hpc}
#full sample
memory_posterior.m = lm(TBX_ibam_scr ~ tail_adjustRO_new  + AgeC + GenderEC , data = pingSubset[!is.na(head_adjustRO_new)]); summary(memory_posterior.m)

#low income
memory_posterior.m_lowIncome = lm(TBX_ibam_scr ~ tail_adjustRO_new  + AgeC + GenderEC + logIncome3, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(memory_posterior.m_lowIncome)

#high income
memory_posterior.m_highIncome = lm(TBX_ibam_scr ~ tail_adjustRO_new  + AgeC + GenderEC + logIncome3, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == 1]); summary(memory_posterior.m_highIncome)
```

```{r vocab ~ anterior HPC}
#full sample
language_anterior.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(language_anterior.m)

language_anterior.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC + Age2 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(language_anterior.m)

#low income
language_anterior_low_income.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC +  GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summaryh(language_anterior_low_income.m)

language_anterior_low_income.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC +  Age2 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summaryh(language_anterior_low_income.m)
```

```{r vocab ~ posterior HPC}
language_posterior.m = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + AgeC + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(language_posterior.m)

#low income
language_posterior.m = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + AgeC + GenderEC + logIncome3, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == -1]); summaryh(language_posterior.m)


#high income
language_posterior.m_high = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + AgeC + GenderEC + logIncome3, data = pingSubset[!is.na(head_adjustRO_new) & incomeSplit == 1]); summaryh(language_posterior.m_high)
```

```{r processing speed ~ anterior HPC}
processing_speed_anterior.m = lm(TBX_pspac_scr ~ head_adjustRO_new  + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(processing_speed_anterior.m)
```

```{r processing speed ~ posterior HPC}
processing_speed_posterior.m = lm(TBX_pspac_scr ~ tail_adjustRO_new + AgeC + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(processing_speed_posterior.m)
```

```{r FDR correction (vol ~ scores) in separate subsamples }
corrected_ps <- data.table(test = c("memory_anterior", "memory_posterior", "vocab_anterior", "vocab_anerior", "ps_anterior", "ps_posterior"), ps = c(0.00546,  0.828,  0.000273 , .606, .131, .148))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]
```
 

Testing whether age moderates cognitive score - hpc subregion relationships
```{r memory ~ anterior HPC * age}
memory_anterior_age_interaction.m = lm(TBX_ibam_scr ~ AgeC * head_adjustRO_new + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(memory_anterior_age_interaction.m)
```

```{r memory scores ~ posterior HPC * age}
memory_posterior_age_interaction.m = lm(TBX_ibam_scr ~  AgeC * tail_adjustRO_new + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(memory_posterior_age_interaction.m)

pingSubset$age_categorical <- relevel(as.factor(pingSubset$age_categorical), ref = "8:12")
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new), summaryh(lm(TBX_ibam_scr ~ tail_adjustRO_new  * age_categorical + AgeC + GenderEC))]

#in discrete age bins
pingSubset[!is.na(tail_adjustRO_new)&!is.na(head_adjustRO_new) & age_categorical %in% c("3:7"), summaryh(lm(TBX_ibam_scr ~ tail_adjustRO_new+ AgeC + GenderEC))]
pingSubset[!is.na(tail_adjustRO_new)&!is.na(head_adjustRO_new) & age_categorical == "8:12", summaryh(lm(TBX_ibam_scr ~ tail_adjustRO_new + AgeC +GenderEC))]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical == "13:17", summaryh(lm(TBX_ibam_scr ~ tail_adjustRO_new+ AgeC +GenderEC))]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical == "18:21", summaryh(lm(TBX_ibam_scr ~ tail_adjustRO_new + AgeC +GenderEC))]
```

```{r vocab scores ~ anterior HPC * age}
language_anterior_age_interaction.m = lm(TBX_VOCAB_THETA ~  AgeC * head_adjustRO_new + logIncome3 + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(language_anterior_age_interaction.m)
```

```{r vocab ~ posterior HPC * age}
language_posterior_age_interaction.m = lm(TBX_VOCAB_THETA ~  AgeC * tail_adjustRO_new + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(language_posterior_age_interaction.m)

pingSubset$age_categorical <- relevel(as.factor(pingSubset$age_categorical), ref = "8:12")
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new), summaryh(lm(TBX_VOCAB_THETA ~ tail_adjustRO_new  * age_categorical  + AgeC + GenderEC))] #controlling for age

#in discrete age bins
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical %in% c("3:7"), summaryh(lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + GenderEC+ AgeC))]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical == "8:12", summaryh(lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + GenderEC+ AgeC))]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical == "13:17", summaryh(lm(TBX_VOCAB_THETA ~ tail_adjustRO_new+ GenderEC+ AgeC))]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & age_categorical == "18:21", summaryh(lm(TBX_VOCAB_THETA ~ tail_adjustRO_new+ GenderEC+ AgeC))]
```

```{r prepare to plot the relationship between cognitive scores and hippocampal volumes}
#create residualized cognitive scorse removing effects of age, gender and income
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr), 
           memory_residuals := residuals(lm(TBX_ibam_scr ~ AgeC + GenderEC))]

pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr), 
          language_residuals := residuals(lm(TBX_VOCAB_THETA ~ AgeC + GenderEC))]

#z-score these values
pingSubset[, memory_residualsZ := scale(memory_residuals)]
pingSubset[, language_residualsZ := scale(language_residuals)]

#gather to long form data
toGather <- pingSubset[, .(ID, memory_residualsZ, language_residualsZ, tail_adjustRO_new, head_adjustRO_new, income3)]
toPlot <- gather(toGather[!is.na(memory_residualsZ) & !is.na(language_residualsZ) & !is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new)], region, volume, -c(ID, memory_residualsZ, language_residualsZ, income3))

setDT(toPlot)
toPlot[region == "tail_adjustRO_new", region := "Posterior"]
toPlot[region == "head_adjustRO_new", region := "Anterior"]
toPlot[region == "Anterior" & income3 > 76000, summaryh(lm(language_residualsZ ~ volume))]

#longpingSubset
#setnames(longpingSubset,old = "volume", new = "volumeZ")
#longpingSubset <- left_join(longpingSubset, toMerge[, c(1, 6,7)])
#toGather <- pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new), .(ID, tail_adjustRO_new, head_adjustRO_new, logIncome3, AgeC, GenderEC, DeviceSerialNumber2)]
#setDT(longpingSubset)
#left_join(longpingSubset, toMerge[, c(1,)])
#longpingSubset$region = relevel(longpingSubset$region, ref = "Posterior")
```

```{r FDR correction (vol ~ scores * age)  }
age_inter_vols_scores <- data.table(test = c("age_inter_memory_anterior", "age_inter_memory_posterior", "age_inter_vocab_anterior", "age_inter_vocab_anerior"), ps = c( 0.17942  , .003 , .789, .005))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]
```
 

Testing whether income subsample moderates the relationship between cognitive scores and subregion volumes
```{r memory scores ~ anterior HPC * income subsample}
memory_anterior_interaction.m = lm(TBX_ibam_scr ~ head_adjustRO_new * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(memory_anterior_interaction.m)
```

```{r vocab scores ~ anterior HPC * income subsample}
vocab_anterior_interaction.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new)]);summary(vocab_anterior_interaction.m)
```

```{r memory scores ~ posterior HPC * income subsample}
memory_posterior_interaction.m = lm(TBX_ibam_scr ~ tail_adjustRO_new * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summary(memory_posterior_interaction.m)
```

```{r vocab scores ~ posterior HPC * income subsample}
vocab_posterior_interaction.m = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new * incomeSplit + AgeC + GenderEC, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(vocab_posterior_interaction.m)
```

```{r FDR correction (vol ~ scores * income subsample) }
group_inter_scores_vols <- data.table(test = c("group_inter_memory_anterior", "group_inter_memory_posterior", "group_inter_vocab_anterior", "group_inter_vocab_posterior"), ps = c( 0.2751, 0.413, 0.61087, .971))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]

corrected_ps <- rbind(age_inter_vols_scores, group_inter_scores_vols)
```
 

Cognitive scores ~ subregion volumes separately for lower and higher income subsamples
Anterior HPC
```{r memory scores ~ anterior HPC in lower income subsample}
memory_anterior_lower_income.m = lm(TBX_ibam_scr ~ head_adjustRO_new  + AgeC  + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summaryh(memory_anterior_lower_income.m)
```

```{r memory scores ~ anterior HPC in higher income subsample}
memory_anterior_higher_income.m = lm(TBX_ibam_scr ~ head_adjustRO_new  + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summaryh(memory_anterior_higher_income.m)
```

```{r vocab ~ anterior HPC in lower income subsample}
language_anterior_lower_income.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC + GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(language_anterior_lower_income.m)
```

```{r vocab ~ anterior HPC in higher income subsample}
language_anterior_higher_income.m = lm(TBX_VOCAB_THETA ~ head_adjustRO_new + AgeC + GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summaryh(language_anterior_higher_income.m)
```

Posterior HPC
```{r memory scores ~ posterior HPC in lower income subsample}
memory_posterior_lower_income.m = lm(TBX_ibam_scr ~ tail_adjustRO_new  + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(memory_posterior_lower_income.m)
```

```{r memory scores ~ posterior HPC in higher income subsample}
memory_posterior_higher_income.m = lm(TBX_ibam_scr ~ tail_adjustRO_new  + AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summary(memory_posterior_higher_income.m)
```

```{r vocab ~ posterior HPC in lower income subsample}
language_posterior_lower_income.m = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + AgeC + GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == -1]); summary(language_posterior_lower_income.m)
```

```{r vocab ~ posterior HPC in higher income subsample}
language_posterior_higher_income.m = lm(TBX_VOCAB_THETA ~ tail_adjustRO_new + AgeC + GenderEC , data = pingSubset[!is.na(tail_adjustRO_new) & incomeSplit == 1]); summary(language_posterior_higher_income.m)
```

```{r FDR correction (vol ~ scores) in separate subsamples }
scores_vols_group_sep <- data.table(test = c("memory_anterior_low", "memory_anterior_high", "vocab_anterior_low", "vocab_anterior_high", "memory_posterior_low", "memory_posterior_high", "vocab_posterior_low", "vocab_posterior_high"), ps = c(.009, .334, 0.0147,.011, 0.414, 0.600   , 0.555, 0.96470))
corrected_ps[, adjusted := p.adjust(ps, method = "fdr")]


# join
corrected_ps <- rbind(corrected_ps, scores_vols_group_sep)

corrected_ps[, p_adjust := p.adjust(ps, method = 'fdr')]
```
 
Figure - relationship between volumes and cognitive scores
```{r plot relationship beween volumes and cognitive scores}
#whole sample - volumes and memory 
ggplot(toPlot, aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior"]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior"]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2
ggsave(filename = "memory_ant_post.png", width = 5.5, height = 3)

#lower income - volumes and memory 
ggplot(toPlot, aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior" & income3 < 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior" & income3 < 76000]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
ggtheme2 +
  scale_y_continuous(breaks = c(-0.3, 0, 0.3))
ggsave(filename = "memory_ant_post_low.png", width = 5.5, height = 3)

#higher income - volumes and memory
ggplot(toPlot, aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior" & income3 > 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior" & income3 > 76000]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
ggtheme2 +
  scale_y_continuous(breaks = c(-0.3, 0, 0.3)) +
  scale_x_continuous(limits = c(1500, 3000))
ggsave(filename = "memory_ant_post_high.png", width = 5.5, height = 3)

#full  sample - language and volumes
ggplot(toPlot, aes(volume, language_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior"]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior"]) +
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2 
ggsave(filename = "language_ant_post_low.png", width = 5.5, height = 3)

#lower income sample - language and volumes
ggplot(toPlot, aes(volume, language_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior" & income3 < 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior"& income3 < 76000]) +
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2 
ggsave(filename = "language_ant_post_low.png", width = 5.5, height = 3)

#higher income sample - language and volumes
ggplot(toPlot, aes(volume, language_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset[region == "Posterior" & income3 > 76000]) +
 geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset[region == "Anterior"& income3 > 76000]) +
  #geom_smooth(formula = y ~ x, method = "lm")+
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme +
  scale_x_continuous(breaks = c(1500, 2000, 2500, 3000), limits = c(1500, 3000))
ggsave(filename = "language_ant_post_high.png", width = 5.5, height = 3)
```


####Analyses to assess whether anterior volumes mediate the relationship between income and memory ####
Analysis to test whether anterior volumes mediate the relationship between income and memory scores
```{r z score values so we can report standardized coefficients}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new) & !is.na(TBX_ibam_scr), TBX_ibam_scrZ := scale(TBX_ibam_scr)]
pingSubset[!is.na(head_adjustRO_new)& !is.na(tail_adjustRO_new) & !is.na(TBX_VOCAB_THETA), TBX_VOCAB_THETAZ := scale(TBX_VOCAB_THETA)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), anterior_adjustZ := scale(head_adjustRO_new)]
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new)& !is.na(TBX_ibam_scr), posterior_adjustZ := scale(tail_adjustRO_new)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), whole_adjustZ := scale(whole_adjust)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), AgeZ := scale(AgeC)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), Age2Z := scale(Age2)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), Age3Z := scale(Age3)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), logIncome3Z := scale(logIncome3)]
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)& !is.na(TBX_ibam_scr), scanner := DeviceSerialNumber2]
```

Episodic memory scores - Ahipp volumes  --- Full sample (z-scored mediation) ** only linear effects of age included
```{r mediation analysis for income- episodic memory score relationship in full sample}
source( "http://page-gould.com/scripts/r/mediations_patch.r" ) # Needed to update the mediations function
anterior_memory.y <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(anterior_memory.y)
anterior_memory.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new)]); summary(anterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_memory <- mediate(model.m = anterior_memory.m, model.y = anterior_memory.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE)
summary(model.mediate_anterior_memory); standard.errors(model.mediate_anterior_memory)
```

Episodic memory scores - Ahipp volumes  --- Full sample (z-scored mediation) *** nonlinear effects of age included
```{r mediation analysis for income- episodic memory score relationship in full sample}
anterior_memory.y_nonlinear <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ + Age2Z + Age3Z + logIncome3Z + scanner, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(anterior_memory.y)
anterior_memory.m_nonlinear <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new)]); summary(anterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_memory_nonlinear <- mediate(model.m = anterior_memory.m_nonlinear, model.y = anterior_memory.y_nonlinear, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE)
summary(model.mediate_anterior_memory_nonlinear); standard.errors(model.mediate_anterior_memory_nonlinear)
```

Episodic memory scores -  Ahipp volumes --- lower income subsample (z-scored mediation) ** linear effects of age included only
```{r mediation analysis for income- episodic memory score relationship in lower income subsample}
anterior_memory.y <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ  + logIncome3Z + scanner, data = pingSubset[!is.na(tail_adjustRO_new) & income3 < 76000]); summaryh(anterior_memory.y)
anterior_memory.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new) & income3 < 76000]); summary(anterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_memory_low_income <- mediate(model.m = anterior_memory.m, model.y = anterior_memory.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeC", "scanner"))
summary(model.mediate_anterior_memory_low_income); standard.errors(model.mediate_anterior_memory_low_income)
```

Episodic memory scores -  Ahipp volumes --- lower income subsample (z-scored mediation) *** nonlinear effects of age included 
```{r mediation analysis for income- episodic memory score relationship in lower income subsample}
anterior_memory.y_nonlinear <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ  + Age2Z + logIncome3Z + scanner, data = pingSubset[!is.na(tail_adjustRO_new) & income3 < 76000]); summaryh(anterior_memory.y_nonlinear)
anterior_memory.m_nonlinear <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new) & income3 < 76000]); summary(anterior_memory.m_nonlinear) 
model.mediate_anterior_memory_low_income_nonlinear <- mediate(model.m = anterior_memory.m_nonlinear, model.y = anterior_memory.y_nonlinear, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "Age2Z", "scanner"))
summary(model.mediate_anterior_memory_low_income_nonlinear); standard.errors(model.mediate_anterior_memory_low_income_nonlinear)
```

Episodic memory scores - Ahipp volumes --- higher income subsample ** linear effect of age only
```{r mediation analysis for income- episodic memory score relationship in higher income subsample}
anterior_memory.y <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(tail_adjustRO_new) & income3 > 76000]); summaryh(anterior_memory.y)
anterior_memory.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new) & income3 > 76000]); summary(anterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_memory_high_income <- mediate(model.m = anterior_memory.m, model.y = anterior_memory.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_anterior_memory_high_income); standard.errors(model.mediate_anterior_memory_high_income)
```

#vocab mediations
vocab scores - Ahipp volumes ---full sample (z-scored) ** linear effect of age included only
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.y)
anterior_language.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.m) 
model.mediate_anterior_language <- mediate(model.m = anterior_language.m, model.y = anterior_language.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner", "Age2Z"))
summary(model.mediate_anterior_language); standard.errors(model.mediate_anterior_language)
```

vocab scores - Ahipp volumes ---full sample (z-scored) ** nonlinear effect of age included 
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y_nonlinear <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + Age2Z + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.y_nonlinear)
anterior_language.m_nonlinear <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.m_nonlinear) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_language_nonlinear <- mediate(model.m = anterior_language.m_nonlinear, model.y = anterior_language.y_nonlinear, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner", "Age2Z"))
summary(model.mediate_anterior_language_nonlinear); standard.errors(model.mediate_anterior_language_nonlinear)
```

vocab scores - Ahipp volumes ---low income subsample ** linear effect of age only
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 < 76000]); summary(anterior_language.y)
anterior_language.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 < 76000]); summary(anterior_language.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_language_low_income <- mediate(model.m = anterior_language.m, model.y = anterior_language.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE)
summary(model.mediate_anterior_language_low_income); standard.errors(model.mediate_anterior_language_low_income)
```

vocab scores - Ahipp volumes ---low income subsample ** nonlinear effect of age 
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y_nonlinear <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + Age2Z + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 < 76000]); summary(anterior_language.y)
anterior_language.m_nonlinear <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 < 76000]); summary(anterior_language.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_language_low_income_nonlinear <- mediate(model.m = anterior_language.m_nonlinear, model.y = anterior_language.y_nonlinear, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE)
summary(model.mediate_anterior_language_low_income_nonlinear); standard.errors(model.mediate_anterior_language_low_income_nonlinear)
```

mediation - vocab scores - Ahipp volumes ---high income subsample ** only linear age term included
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 > 76000]); summary(anterior_language.y)
anterior_language.m <- lm(anterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ) & income3 > 76000]); summary(anterior_language.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_language_high_income <- mediate(model.m = anterior_language.m, model.y = anterior_language.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_anterior_language_high_income); standard.errors(model.mediate_anterior_language_high_income)
```


#posterior hpc and whole hpc volume mediations
mediation - Memory scores - phipp volumes --- full sample
```{r posterior volumes and memory scores mediation -- full sample}
posterior_memory.y <- lm(TBX_ibam_scrZ ~ posterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(posterior_memory.y)
posterior_memory.m <- lm(posterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(posterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_posterior_memory <- mediate(model.m = posterior_memory.m, model.y = posterior_memory.y, sims = 5000, treat = "logIncome3Z", mediator = "posterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_posterior_memory); standard.errors(model.mediate_posterior_memory)
```
mediation - vocab scores - phipp volumes --- full sample
```{r posterior volumes and memory scores mediation -- full sample}
posterior_language.y <- lm(TBX_VOCAB_THETAZ ~ posterior_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(posterior_language.y)
posterior_language.m <- lm(posterior_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(posterior_language.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_posterior_language <- mediate(model.m = posterior_language.m, model.y = posterior_language.y, sims = 5000, treat = "logIncome3Z", mediator = "posterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_posterior_language); standard.errors(model.mediate_posterior_language)
```
mediation - Memory Scores - whole hipp -- full sample
```{r Memory Scores - whole hipp -- full sample}
whole_memory.y <- lm(TBX_ibam_scrZ ~ whole_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(whole_memory.y)
whole_memory.m <- lm(whole_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(whole_memory.m) #NOTE: is.na(TBX_ibam_scrZ) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_whole_memory <- mediate(model.m = whole_memory.m, model.y = whole_memory.y, sims = 5000, treat = "logIncome3Z", mediator = "whole_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_whole_memory); standard.errors(model.mediate_whole_memory)
```
mediation - vocab Scores - whole hipp -- full sample
```{r Memory Scores - whole hipp -- full sample}
whole_language.y <- lm(TBX_VOCAB_THETAZ ~ whole_adjustZ + GenderEC + AgeZ + logIncome3Z + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(whole_language.y)
whole_language.m <- lm(whole_adjustZ ~logIncome3Z + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_ibam_scrZ)]); summary(whole_language.m) #NOTE: is.na(TBX_VOCAB_THETAZ) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_whole_language <- mediate(model.m = whole_language.m, model.y = whole_language.y, sims = 5000, treat = "logIncome3Z", mediator = "whole_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner"))
summary(model.mediate_whole_language); standard.errors(model.mediate_whole_language)
```


#analyses using education rather than income
Cognition - education models
```{r memory ~ education models}
Education_memory.m <- lm(TBX_ibam_scr ~ educationAvg_recode +AgeC + GenderEC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Education_memory.m)
```

```{r vocabulary ~ education models}
Education_language.m <- lm(TBX_VOCAB_THETA ~ educationAvg_recode + GenderEC + AgeC, data = pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new)]); summaryh(Education_language.m)
```

subregion - education models
```{r anterior vols ~ income}
Education_anterior.m <- lm(head_adjustRO_new ~ educationAvg_recode + AgeC + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(tail_adjustRO_new)]); summaryh(Education_anterior.m)
```

```{r posterior vols ~ income}
Education_posterior.m <- lm(tail_adjustRO_new ~ educationAvg_recode + AgeC  + GenderEC +  DeviceSerialNumber, data = pingSubset[!is.na(head_adjustRO_new)]); summaryh(Education_posterior.m)
```

Mediation analysis
Does anterior hippocampaus mediate education-related gaps in cognition?

Analysis to test whether anterior volumes mediate the relationship between income and memory scores
```{r z score values so we can report standardized coefficients}
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr), educationAvg_recodeZ := scale(educationAvg_recode)]
```

Episodic memory scores - Ahipp volumes  --- Full sample (z-scored mediation) ** only linear effects of age included
```{r mediation analysis for income- episodic memory score relationship in full sample}
source( "http://page-gould.com/scripts/r/mediations_patch.r" ) # Needed to update the mediations function
anterior_memory.y <- lm(TBX_ibam_scrZ ~ anterior_adjustZ + GenderEC + AgeZ + educationAvg_recodeZ + scanner, data = pingSubset[!is.na(tail_adjustRO_new)]); summary(anterior_memory.y)
anterior_memory.m <- lm(anterior_adjustZ ~educationAvg_recodeZ + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(TBX_ibam_scrZ) & !is.na(tail_adjustRO_new)]); summary(anterior_memory.m) #NOTE: is.na(TBX_ibam_scr) is to ensure that only individuals with memory scores are included in mediation model
model.mediate_anterior_memory <- mediate(model.m = anterior_memory.m, model.y = anterior_memory.y, sims = 5000, treat = "educationAvg_recodeZ", mediator = "anterior_adjustZ",boot = TRUE)
summary(model.mediate_anterior_memory); standard.errors(model.mediate_anterior_memory)
```

vocab scores - Ahipp volumes ---full sample (z-scored) ** linear effect of age included only
```{r mediation analysis for income- vocabulary scores relationship in full sample}
anterior_language.y <- lm(TBX_VOCAB_THETAZ ~ anterior_adjustZ + GenderEC + AgeZ + educationAvg_recodeZ + scanner, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.y)
anterior_language.m <- lm(anterior_adjustZ ~educationAvg_recodeZ + AgeZ + scanner + GenderEC, data = pingSubset[!is.na(anterior_adjustZ) & !is.na(posterior_adjustZ) & !is.na(TBX_VOCAB_THETAZ)]); summary(anterior_language.m) 
model.mediate_anterior_language <- mediate(model.m = anterior_language.m, model.y = anterior_language.y, sims = 5000, treat = "logIncome3Z", mediator = "anterior_adjustZ",boot = TRUE, covariates = c("GenderEC", "AgeZ", "scanner", "Age2Z"))
summary(model.mediate_anterior_language); standard.errors(model.mediate_anterior_language)
```


Figures
```{r save ggtheme}
ggtheme <- theme(plot.caption = element_text(hjust = -.2), 
        panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        axis.line.x = element_line(size = 1, linetype = "solid", colour = "black"), 
        axis.line.y = element_line(size = 1, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 16, colour = 'black'), 
        axis.text.y = element_text(size = 16, colour = 'black'), 
        plot.title = element_text(size = 16, hjust = 0.5),
        text = element_text(size = 16), panel.spacing.x = unit(1, "lines"),
        legend.key = element_blank(), legend.key.height = unit(2, 'line')) 
```

```{r Figure 1c, d}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new) & !is.na(TBX_ibam_scr), 
           memory_residualsZ := scale(residuals(lm(TBX_ibam_scr ~ AgeC + GenderEC)))]
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new) & !is.na(TBX_VOCAB_THETA), 
           vocab_residualsZ := scale(residuals(lm(TBX_VOCAB_THETA ~ AgeC + GenderEC)))]


#log income and memory
ggplot(pingSubset, aes(logIncome3, memory_residualsZ)) +
  geom_jitter( color = 'purple', shape = 1, alpha = 0.5, size = 3) +
  stat_smooth(method ="lm", formula = y ~ x, color = 'purple')  +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), 
                     labels = c(5, 10, 20, 40, 80, 160, 300)) +
  labs(y = "Memory (z scores)", x = "Income (thousands; log scale)") +
  ggtheme
  
ggsave("income_memory.png", width = 5.5, height = 3)

#log income and vocab
ggplot(pingSubset, aes(logIncome3, vocab_residualsZ)) +
  geom_jitter( color = 'seagreen3', shape = 1, alpha = 0.4, size = 3) +
  stat_smooth(method ="lm", formula = y ~ x, color = 'darkgreen')  +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), 
                     labels = c(5, 10, 20, 40, 80, 160, 300)) +
  labs(y = "Vocabulary (z scores)", x = "Income (thousands; log scale)") +
  ggtheme
ggsave("income_vocab.png", width = 5.5, height = 3)

```

```{r Figure 1e, f}
#log income and memomry
ggplot(pingSubset, aes(income3, memory_residualsZ)) +
  #geom_jitter( color = 'darkgreen', shape = 1, alpha = 0.5, size = 2) +
  #stat_smooth(method ="lm", formula = y ~ x, color = 'darkgreen')  +
  labs(y = "Memory (z scores)", x = "Income (thousands; linear scale)") +
  ggtheme+
      geom_smooth(formula = y ~ x, method = 'lm', color = 'purple', data = pingSubset[income3 < 76000])+
      geom_smooth(formula = y ~ x, method = 'lm', color = 'purple',data = pingSubset[income3 > 76000])
ggsave("income_memory_linear.png", width = 5.5, height = 3)

  
#linear income and vocab
ggplot(pingSubset, aes(income3, vocab_residualsZ)) +
  #geom_jitter( color = 'darkgreen', shape = 1, alpha = 0.5, size = 2) +
  #stat_smooth(method ="lm", formula = y ~ x, color = 'darkgreen')  +
  labs(y = "Vocabulary (z scores)", x = "Income (thousands; linear scale)") +
  ggtheme+
      geom_smooth(formula = y ~ x, method = 'lm', color = 'darkgreen', data = pingSubset[income3 < 76000])+
      geom_smooth(formula = y ~ x, method = 'lm', color = 'darkgreen',data = pingSubset[income3 > 76000])

ggsave("income_vocab_linear.png", width = 5.5, height = 3)
```

```{r Figure 2b, c}
posteriorCol = "dodgerblue"
anteriorvolscolor ="violetred"
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), tail_adjustRO_new_residualsZ := scale(residuals(lm(tail_adjustRO_new ~ AgeC + GenderEC)))]
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), head_adjustRO_new_residualsZ := scale(residuals(lm(head_adjustRO_new ~ AgeC + GenderEC)))]
longpingSubset_analysis[, volumeZ := scale(residuals(lm(volume ~ AgeC + GenderEC))), by = region2]
longpingSubset_analysis <- left_join(longpingSubset_analysis, pingSubset[, .(ID, income3)])

#figure 2b
ggplot(longpingSubset_analysis, aes(logIncome3, volumeZ, col = region)) +
  ggtheme2 +
    geom_smooth(formula = y ~ x, method = 'lm')+
scale_color_manual(values  = c(posteriorCol, anteriorvolscolor))+
   labs(y = "Volumes (z scores)", x = "Income (thousands; linear scale)") 


#figure 2c
ggplot(longpingSubset_analysis, aes(income3/1000, volumeZ, col = region)) +
  ggtheme2 +
    geom_smooth(formula = y ~ x, method = 'lm', data = longpingSubset[income3 < 76000])+
      geom_smooth(formula = y ~ x, method = 'lm', data = longpingSubset[income3 > 76000])+
scale_color_manual(values  = c(posteriorCol, anteriorvolscolor))+
   labs(y = "Volumes (z scores)", x = "Income (thousands; linear scale)") 

ggsave(filename = "income_linear_antPost.png",width = 5, height = 3)
```

```{r figures 3a, b, c, d, e, f}
longpingSubset_analysis <- left_join(longpingSubset_analysis, pingSubset[, .(ID, memory_residualsZ, vocab_residualsZ)])

#figure 3a
ggplot(longpingSubset_analysis, aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new"]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2


#figure 3b
ggplot(longpingSubset_analysis, aes(volume,vocab_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new"]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"]) +
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2


#figure 3c
ggplot(longpingSubset_analysis, aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new"]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2


#figure 3d
ggplot(longpingSubset_analysis[income3 < 76000], aes(volume,vocab_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new" & income3 < 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"& income3 < 76000]) +
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2


#figure 3e
ggplot(longpingSubset_analysis[income3 > 76000], aes(volume, memory_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new" & income3 > 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"& income3 > 76000]) +
   labs(y = "Memory (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2

#figure 3f
ggplot(longpingSubset_analysis[income3 > 76000], aes(volume,vocab_residualsZ, col = region)) +
   geom_smooth(formula = y ~ x, method = 'lm', col = posteriorCol, data = longpingSubset_analysis[region == "tail_adjustRO_new" & income3 > 76000]) +
  geom_smooth(formula = y ~ x, method = 'lm', col = anteriorvolscolor, data = longpingSubset_analysis[region == "head_adjustRO_new"& income3 > 76000]) +
   labs(y = "Vocabulary (z scores)", x = " ", col = " ")+
     #theme(plot.caption = element_text(hjust = -.2, size  = 12)) +
ggtheme2
```


Supplementary Figures
```{r Suppl 1a, b}

ggplot(pingSubset, aes(Age, TBX_ibam_scr)) +
  geom_smooth(formula = y ~ x, method = 'lm', color = 'darkgreen', data = pingSubset[logIncome3 %in% min(logIncome3)])+
  geom_smooth(formula = y ~ x, method = 'lm', color = 'purple',data = pingSubset[logIncome3 %in% max(logIncome3)]) +
  ggtheme


ggplot(pingSubset, aes(Age, TBX_VOCAB_THETA)) +
  geom_smooth(formula = y ~ x, method = 'lm', color = 'darkgreen', data = pingSubset[logIncome3 %in% min(logIncome3)])+
  geom_smooth(formula = y ~ x, method = 'lm', color = 'purple',data = pingSubset[logIncome3 %in% max(logIncome3)]) +
  ggtheme
```

```{r Suppl 6}

pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), tail_adjustRO_newZ := scale(tail_adjustRO_new)]
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), head_adjustRO_newZ := scale(head_adjustRO_new)]

#age and anterior
ggplot(pingSubset, aes(Age, head_adjustRO_newZ)) +
  geom_jitter(color = anteriorvolscolor) +
stat_smooth(formula = y ~ x, method = "lm", color = "black") +
  ggtheme


#age and poserior
ggplot(pingSubset, aes(Age, tail_adjustRO_newZ)) +
  geom_jitter(color = "dodgerblue") +
stat_smooth(formula = y ~ x, method = "lm", color = "black") +
  ggtheme
```

```{r Suppl Figure 7a}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), ]%>%
  ggplot(aes(logIncome3, scale(TBX_ibam_scr), col = age_categorical )) +
  stat_smooth(method  = "lm", formula = y~ x) +
ggtheme +
  labs(y = "Memory (z scores)", col = "Age group", x = "Income") +
  scale_color_discrete(breaks = c("18:21","13:17", "8:12", "3:7"), labels = c("young adults", "adolescents", "older children", "younger children" )) +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), labels = c(5, 10, 20, 40, 80, 160, 300)) +
  scale_y_continuous(limits = c(-2, 2))
ggsave(filename = "age_inter_income_memory.png", width = 6, height = 3.2)

```

```{r Suppl Figure 7b}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), ]%>%
  ggplot(aes(logIncome3, scale(TBX_VOCAB_THETA), col = age_categorical )) +
  stat_smooth(method  = "lm", formula = y~ x) +
ggtheme +
  labs(y = "Vocab (z scores)", col = "Age group", x = "Income") +
  scale_color_discrete(breaks = c("18:21","13:17", "8:12", "3:7"), labels = c("young adults", "adolescents", "older children", "younger children" )) +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), labels = c(5, 10, 20, 40, 80, 160, 300)) +
  scale_y_continuous(limits = c(-2, 2))

ggsave(filename = "age_inter_income_vocab.png", width = 6, height = 3.2)
```

```{r Suppl Figure 8a}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), ]%>%
  ggplot(aes(logIncome3, scale(head_adjustRO_new), col = age_categorical )) +
  stat_smooth(method  = "lm", formula = y~ x) +
ggtheme +
  labs(y = "Anterior volumes (z scores)", col = "Age group", x = "Income") +
  scale_color_discrete(breaks = c("18:21","13:17", "8:12", "3:7"), labels = c("young adults", "adolescents", "older children", "younger children" )) +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), labels = c(5, 10, 20, 40, 80, 160, 300))
ggsave(filename = "age_inter_income_ant.png", width = 6, height = 3.2)
```

```{r Suppl Figure 8b}
pingSubset[!is.na(head_adjustRO_new) & !is.na(tail_adjustRO_new), ]%>%
  ggplot(aes(logIncome3, scale(tail_adjustRO_new), col = age_categorical )) +
  stat_smooth(method  = "lm", formula = y~ x) +
ggtheme +
  labs(y = "Posterior volumes (z scores)", col = "Age group", x = "Income") +
  scale_color_discrete(breaks = c("18:21","13:17", "8:12", "3:7"), labels = c("young adults", "adolescents", "older children", "younger children" )) +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), labels = c(5, 10, 20, 40, 80, 160, 300))
ggsave(filename = "age_inter_income_post.png", width = 6, height = 3.3)
```

```{r Suppl Figure 9a b}

ggplot(pingSubset, aes(logIncome3, head_adjustRO_newZ)) +
  geom_jitter(color = anteriorvolscolor, alpha  = 0.3) +
  ggtheme +
stat_summary(fun.y = mean, geom = "point", size = 2) +
   stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, size = 1)+
  labs(y = "Volumes (Z scores)", x = "Income (thousands)") +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), 
                     labels = c(5, 10, 20, 40, 80, 160, 300))



ggplot(pingSubset, aes(logIncome3, tail_adjustRO_newZ)) +
  geom_jitter(color = "dodgerblue", alpha  = 0.3) +
  ggtheme +
stat_summary(fun.y = mean, geom = "point", size = 2) +
   stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, size = 1)+
  labs(y = "Volumes (Z scores)", x = "Income (thousands)") +
  scale_x_continuous(breaks = c( 8.51719, 9.21034, 9.903488,10.59663,11.28978,11.98293,12.61154), 
                     labels = c(5, 10, 20, 40, 80, 160, 300))

```

```{r Suppl Figure 10a b c d}

#figure 10a memory and anterior hpc volumes
ggplot(pingSubset, aes(head_adjustRO_new, memory_residualsZ)) +
  geom_jitter(color = anteriorvolscolor, alpha = 0.2) +
  ggtheme +
  stat_smooth(formula = y ~ x, method = "lm", color='black') +
  labs(x = "Volumes (mm3)", y  = "Memory (z scores)")

#figure 10b memory and posterior hpc volummes
ggplot(pingSubset, aes(tail_adjustRO_new, memory_residualsZ)) +
  geom_jitter(color = "dodgerblue", alpha = 0.2) +
  ggtheme +
  stat_smooth(formula = y ~ x, method = "lm", color='dodgerblue') +
  labs(x = "Volumes (mm3)", y  = "Memory (z scores)")
ggsave(filename = "memory_post.png", width = 5.5, height = 3)


#figure 10c vocab and anterior HPC volumes
ggplot(pingSubset, aes(head_adjustRO_new, vocab_residualsZ)) +
  geom_jitter(color = anteriorvolscolor, alpha = 0.2) +
  ggtheme +
  stat_smooth(formula = y ~ x, method = "lm", color='black') +
  labs(x = "Volumes (mm3)", y  = "Language (z scores)")


#figure 10d vocab and posterior hpc volumes
ggplot(pingSubset, aes(tail_adjustRO_new, vocab_residualsZ)) +
  geom_point(color = "dodgerblue", alpha = 0.2) +
  ggtheme +
  stat_smooth(formula = y ~ x, method = "lm", color='dodgerblue') +
  labs(x = "Volumes (mm3)", y  = "Vocabulary (z scores)")
ggsave(filename = "language_ant_post.png", width = 5.5, height = 3)

```

```{r Suppl Figure 13a b}
pingSubset[!is.na(tail_adjustRO_new) & !is.na(head_adjustRO_new) & !is.na(TBX_ibam_scr), processing_speed_residuals := residuals(lm(TBX_pspac_scr ~ AgeC + GenderEC))]


ggplot(pingSubset, aes(logIncome3, processing_speed_residuals)) +
  geom_jitter() + 
  ggtheme + 
  stat_smooth(formula = y ~ x, method = "lm")


ggplot(pingSubset, aes(head_adjustRO_new, processing_speed_residuals)) +
  geom_jitter() + 
  ggtheme + 
  stat_smooth(formula = y ~ x, method = "lm")
```
